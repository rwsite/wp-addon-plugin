# План рефакторинга тестирования WordPress-плагина

## Цель
Перестроить систему тестирования на "Laravel-стиль" подход: простота написания, изоляция, лучшие PHP-практики. Отказаться от WordPress-специфики, использовать Pest для декларативных тестов, in-memory базу для интеграций, фабрики для данных. Сделать тесты легкими для запуска в CI/CD и локально.

## Обоснование
- **Простота**: Pest делает тесты читаемыми и быстрыми в написании (describe/it синтаксис).
- **Изоляция**: In-memory SQLite предотвращает конфликты с реальной БД/средой.
- **Масштабируемость**: Фабрики и структура позволяют легко добавлять новые тесты.
- **CI/CD**: Автоматический запуск с простыми командами.
- **Лучшие практики**: Вдохновлено Laravel, фокус на PHP, не WordPress.

## Чек-лист шагов рефакторинга

### 1. Установка и настройка Pest
- [ ] Добавить Pest в composer.json: `composer require pestphp/pest --dev --with-all-dependencies`
- [ ] Инициализировать Pest: `php artisan pest:init` или `./vendor/bin/pest --init`
- [ ] Обновить composer.json scripts: `"test": "pest", "test:coverage": "pest --coverage"`
- [ ] Удалить Brain\Monkey из composer.json (если не удален)

### 2. Установка дополнительных библиотек
- [ ] Faker для данных: `composer require fakerphp/faker --dev`
- [ ] Обновить PHPUnit до последней версии для совместимости

### 3. Рефакторинг структуры тестов
- [ ] Создать папки:
  - `tests/Unit/` (для изолированных тестов)
  - `tests/Feature/` (для интеграционных с БД)
  - `tests/Factories/` (для генерации данных)
- [ ] Переместить существующие тесты:
  - Unit-тесты в `tests/Unit/`
  - Интеграционные (если есть) в `tests/Feature/`
- [ ] Обновить namespace в тестах на соответствующие папки

### 4. Настройка in-memory базы данных
- [ ] Добавить в `tests/bootstrap.php` подключение к SQLite `:memory:`
- [ ] Создать минимальную WordPress-схему (таблицы wp_posts, wp_options и т.д.) для интеграционных тестов
- [ ] Добавить DatabaseMigrations trait для автоматического сброса БД между тестами
- [ ] Обновить TestCase.php для поддержки DB-соединения

### 5. Создание фабрик для тестовых данных
- [ ] Создать базовый Factory класс в `tests/Factories/`
- [ ] Реализовать PostFactory, AssetFactory и т.д. для генерации объектов/данных
- [ ] Интегрировать Faker для случайных данных

### 6. Миграция существующих тестов на Pest
- [ ] Переписать `AssetMinificationTest.php` на Pest-синтаксис (describe/it)
- [ ] Заменить PHPUnit assertions на Pest (expect()->toBe())
- [ ] Убрать ручные mocks, использовать Pest-helpers
- [ ] Протестировать на одном файле, затем мигрировать остальные

### 7. Упрощение bootstrap и mocking
- [ ] Удалить ручные mock-функции из bootstrap, заменить на Pest-механизмы
- [ ] Оставить только необходимые globals (ABSPATH, WP_CONTENT_DIR)
- [ ] Добавить helpers в TestCase.php для WordPress-mocking (если нужно)

### 8. Настройка CI/CD
- [ ] Создать `.github/workflows/test.yml` для автоматического запуска `composer test`
- [ ] Добавить Docker-образ с Pest и SQLite для консистентной среды
- [ ] Настроить отчеты о покрытии

### 9. Документация и обучение
- [ ] Написать README для тестов: как писать, запускать, примеры
- [ ] Добавить примеры Pest-тестов с фабриками
- [ ] Обучить команду (если применимо)

### 10. Финальное тестирование
- [ ] Запустить все тесты: `composer test`
- [ ] Проверить покрытие: `composer test:coverage`
- [ ] Убедиться в работе в контейнере и локально

## Промпт для AI-ассистента
```
Ты — AI-ассистент для рефакторинга кода. Получи задачу: перестроить систему тестирования WordPress-плагина на "Laravel-стиль" подход с использованием Pest, in-memory базы, фабрик и лучших PHP-практик. 

Проект: /var/www/no-borders.ru/wp-content/plugins/wp-addon-plugin

Шаги выполнения:
1. Установи Pest и дополнительные зависимости (Faker).
2. Создай новую структуру папок: tests/Unit/, tests/Feature/, tests/Factories/.
3. Настрой bootstrap.php для in-memory SQLite и минимальной WP-схемы.
4. Создай базовый TestCase.php с DatabaseMigrations и helpers.
5. Реализуй фабрики (PostFactory, AssetFactory) с Faker.
6. Мигрируй существующие тесты на Pest-синтаксис (describe/it, expect()).
7. Упростите mocking, удалив ручные функции из bootstrap.
8. Настрой CI/CD с GitHub Actions и Docker.
9. Напиши документацию в tests/README.md.
10. Протестируй все: запусти тесты, проверь покрытие.

Используй лучшие практики: изоляция, простота, декларативность. Отказ от WordPress-специфики. Если нужны изменения кода, применяй их поэтапно, проверяя на каждом шаге.
```
